name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: GitHub Environment name
        required: true
        type: string
        default: production
      image_tag:
        description: Docker image tag to deploy (usually commit SHA)
        required: true
        type: string
      ref:
        description: Git ref to sync infra files from
        required: true
        type: string
        default: master

permissions:
  contents: read

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: [self-hosted, linux, x64, terminal]
    timeout-minutes: 30
    environment: ${{ inputs.environment }}

    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_TARGET_DIR: ${{ secrets.DEPLOY_TARGET_DIR }}
      DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
      APP_ENV_FILE: ${{ secrets.APP_ENV_FILE }}
      WALLET_ENV_FILE_SECRET: ${{ secrets.WALLET_ENV_FILE }}
      GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      NGINX_HOST_PORT: ${{ secrets.NGINX_HOST_PORT }}
      EMUFETCH_HOST_PORT: ${{ secrets.EMUFETCH_HOST_PORT }}
      YTDLP_HOST_PORT: ${{ secrets.YTDLP_HOST_PORT }}
      XSCRAPER_HOST_PORT: ${{ secrets.XSCRAPER_HOST_PORT }}
      XSCRAPER_VNC_HOST_PORT: ${{ secrets.XSCRAPER_VNC_HOST_PORT }}
      WALLET_API_HOST_PORT: ${{ secrets.WALLET_API_HOST_PORT }}

    steps:
      - name: Checkout infrastructure files
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Validate required deploy secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for key in DEPLOY_HOST DEPLOY_USER DEPLOY_TARGET_DIR DEPLOY_SSH_KEY; do
            if [[ -z "${!key:-}" ]]; then
              echo "::error::Secret ${key} is required."
              missing=1
            fi
          done
          if [[ "${missing}" -ne 0 ]]; then
            exit 1
          fi

      - name: Compute image names
        shell: bash
        run: |
          set -euo pipefail
          owner="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          repo="$(echo "${GITHUB_REPOSITORY#*/}" | tr '[:upper:]' '[:lower:]')"
          base="ghcr.io/${owner}/${repo}"

          echo "IMAGE_TAG=${{ inputs.image_tag }}" >> "${GITHUB_ENV}"
          echo "APP_IMAGE=${base}/app" >> "${GITHUB_ENV}"
          echo "EMUFETCH_IMAGE=${base}/emufetch" >> "${GITHUB_ENV}"
          echo "YTDLP_IMAGE=${base}/ytdlp" >> "${GITHUB_ENV}"
          echo "XSCRAPER_IMAGE=${base}/xscraper" >> "${GITHUB_ENV}"
          echo "ARBSCANNER_IMAGE=${base}/arbscanner" >> "${GITHUB_ENV}"
          echo "WALLET_IMAGE=${base}/wallet" >> "${GITHUB_ENV}"
          echo "WALLET_ENV_FILE=./secrets/wallet.env" >> "${GITHUB_ENV}"

      - name: Configure SSH client
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          install -m 700 -d ~/.ssh
          printf '%s\n' "${DEPLOY_SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H -p "${port}" "${DEPLOY_HOST}" >> ~/.ssh/known_hosts

      - name: Sync compose and infra files
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "mkdir -p ${DEPLOY_TARGET_DIR} ${DEPLOY_TARGET_DIR}/secrets"

          tar -czf - \
            docker-compose.yml \
            docker-compose.prod.yml \
            nginx \
            clickhouse \
            | ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
              "tar -xzf - -C ${DEPLOY_TARGET_DIR}"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "touch ${DEPLOY_TARGET_DIR}/.env ${DEPLOY_TARGET_DIR}/secrets/app.env ${DEPLOY_TARGET_DIR}/secrets/wallet.env"

      - name: Upload app env file (optional)
        if: ${{ env.APP_ENV_FILE != '' }}
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          app_env_b64="$(printf '%s' "${APP_ENV_FILE}" | base64 -w0)"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "printf '%s' '${app_env_b64}' | base64 -d > ${DEPLOY_TARGET_DIR}/secrets/app.env && printf '%s' '${app_env_b64}' | base64 -d > ${DEPLOY_TARGET_DIR}/.env && chmod 600 ${DEPLOY_TARGET_DIR}/secrets/app.env ${DEPLOY_TARGET_DIR}/.env"

      - name: Upload wallet env file (optional)
        if: ${{ env.WALLET_ENV_FILE_SECRET != '' }}
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          wallet_env_b64="$(printf '%s' "${WALLET_ENV_FILE_SECRET}" | base64 -w0)"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "printf '%s' '${wallet_env_b64}' | base64 -d > ${DEPLOY_TARGET_DIR}/secrets/wallet.env && chmod 600 ${DEPLOY_TARGET_DIR}/secrets/wallet.env"

      - name: Login remote host to GHCR (optional)
        if: ${{ env.GHCR_USERNAME != '' && env.GHCR_TOKEN != '' }}
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"
          printf '%s' "${GHCR_TOKEN}" | ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "docker login ghcr.io -u ${GHCR_USERNAME} --password-stdin"

      - name: Deploy with docker compose
        shell: bash
        run: |
          set -euo pipefail
          port="${DEPLOY_PORT:-22}"

          nginx_host_port="${NGINX_HOST_PORT:-}"
          emufetch_host_port="${EMUFETCH_HOST_PORT:-}"
          ytdlp_host_port="${YTDLP_HOST_PORT:-}"
          xscraper_host_port="${XSCRAPER_HOST_PORT:-}"
          xscraper_vnc_host_port="${XSCRAPER_VNC_HOST_PORT:-}"
          wallet_api_host_port="${WALLET_API_HOST_PORT:-}"

          if [[ "${DEPLOY_TARGET_DIR}" == *"polygon-extra"* ]]; then
            : "${nginx_host_port:=82}"
            : "${emufetch_host_port:=18916}"
            : "${ytdlp_host_port:=18917}"
            : "${xscraper_host_port:=18918}"
            : "${xscraper_vnc_host_port:=15901}"
            : "${wallet_api_host_port:=35960}"
          else
            : "${nginx_host_port:=81}"
            : "${emufetch_host_port:=8916}"
            : "${ytdlp_host_port:=8917}"
            : "${xscraper_host_port:=8918}"
            : "${xscraper_vnc_host_port:=5901}"
            : "${wallet_api_host_port:=25960}"
          fi

          printf -v remote_env \
            "IMAGE_TAG=%q APP_IMAGE=%q EMUFETCH_IMAGE=%q YTDLP_IMAGE=%q XSCRAPER_IMAGE=%q ARBSCANNER_IMAGE=%q WALLET_IMAGE=%q WALLET_ENV_FILE=%q DEPLOY_TARGET_DIR=%q NGINX_HOST_PORT=%q EMUFETCH_HOST_PORT=%q YTDLP_HOST_PORT=%q XSCRAPER_HOST_PORT=%q XSCRAPER_VNC_HOST_PORT=%q WALLET_API_HOST_PORT=%q" \
            "${IMAGE_TAG}" "${APP_IMAGE}" "${EMUFETCH_IMAGE}" "${YTDLP_IMAGE}" "${XSCRAPER_IMAGE}" "${ARBSCANNER_IMAGE}" "${WALLET_IMAGE}" "${WALLET_ENV_FILE}" "${DEPLOY_TARGET_DIR}" "${nginx_host_port}" "${emufetch_host_port}" "${ytdlp_host_port}" "${xscraper_host_port}" "${xscraper_vnc_host_port}" "${wallet_api_host_port}"

          ssh -p "${port}" "${DEPLOY_USER}@${DEPLOY_HOST}" \
            "${remote_env} bash -lc 'set -euo pipefail; cd \"${DEPLOY_TARGET_DIR}\"; docker compose --env-file ./secrets/app.env -f docker-compose.yml -f docker-compose.prod.yml pull; docker compose --env-file ./secrets/app.env -f docker-compose.yml -f docker-compose.prod.yml up -d --no-build --remove-orphans; docker compose --env-file ./secrets/app.env -f docker-compose.yml -f docker-compose.prod.yml ps'"
